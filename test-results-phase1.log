
> sploot@0.1.0 test /Users/phaedrus/Development/sploot
> vitest --run

[33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m

 RUN  v2.1.9 /Users/phaedrus/Development/sploot

 â¯ __tests__/api/search.test.ts (0 test)
 â¯ __tests__/integration/search-flow.test.ts (0 test)
stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should return success when no assets exist
[cron] Auditing 0 assets across all users...

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should correctly identify valid assets
[cron] Auditing 2 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 2,
  valid: 2,
  broken: 0,
  errors: 0,
  percentBroken: '0.00%',
  usersAffected: 0
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should correctly identify broken assets (404)
[cron] Auditing 2 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 2,
  valid: 0,
  broken: 2,
  errors: 0,
  percentBroken: '100.00%',
  usersAffected: 1
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should track broken assets per user
[cron] Auditing 3 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 3,
  valid: 0,
  broken: 3,
  errors: 0,
  percentBroken: '100.00%',
  usersAffected: 2
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should send alert when >10 broken assets found
[cron] Auditing 12 assets across all users...
[cron] Audit complete: {
  totalTime: '1ms',
  totalAssets: 12,
  valid: 0,
  broken: 12,
  errors: 0,
  percentBroken: '100.00%',
  usersAffected: 1
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should not send alert when â‰¤10 broken assets found
[cron] Auditing 10 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 10,
  valid: 0,
  broken: 10,
  errors: 0,
  percentBroken: '100.00%',
  usersAffected: 1
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should handle fetch errors gracefully
[cron] Auditing 2 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 2,
  valid: 0,
  broken: 0,
  errors: 2,
  percentBroken: '0.00%',
  usersAffected: 0
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should handle mixed results (valid, broken, error)
[cron] Auditing 3 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 3,
  valid: 1,
  broken: 1,
  errors: 1,
  percentBroken: '33.33%',
  usersAffected: 1
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Asset Discovery > should return success when no assets need processing
[cron] Found 0 assets needing embeddings

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Asset Discovery > should find assets older than 1 hour with no embedding
[cron] Found 0 assets needing embeddings

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Asset Discovery > should process batch of 10 assets maximum
[cron] Found 0 assets needing embeddings

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Asset Discovery > should process oldest assets first
[cron] Found 0 assets needing embeddings

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Embedding Processing > should successfully process assets and generate embeddings
[cron] Found 2 assets needing embeddings
[cron] Processing asset asset-1 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-1 (0ms)
[cron] Processing asset asset-2 (created Thu Oct 02 2025 09:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-2 (0ms)
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 2,
  successful: 2,
  failed: 0,
  successRate: '100%',
  avgProcessingTime: '0ms'
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Embedding Processing > should call upsertAssetEmbedding with correct parameters
[cron] Found 1 assets needing embeddings
[cron] Processing asset asset-123 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-123 (0ms)
[cron] Processing complete: {
  totalTime: '1ms',
  processed: 1,
  successful: 1,
  failed: 0,
  successRate: '100%',
  avgProcessingTime: '0ms'
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Embedding Processing > should handle embedding generation failure
[cron] Found 1 assets needing embeddings
[cron] Processing asset asset-fail (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 1,
  successful: 0,
  failed: 1,
  successRate: '0%',
  avgProcessingTime: '0ms'
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Embedding Processing > should continue processing after single asset failure
[cron] Found 2 assets needing embeddings
[cron] Processing asset asset-fail (created Thu Oct 02 2025 09:36:21 GMT-0500 (Central Daylight Time))
[cron] Processing asset asset-success (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-success (0ms)
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 2,
  successful: 1,
  failed: 1,
  successRate: '50%',
  avgProcessingTime: '0ms'
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Embedding Processing > should handle upsert failure
[cron] Found 1 assets needing embeddings
[cron] Processing asset asset-upsert-fail (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 1,
  successful: 0,
  failed: 1,
  successRate: '0%',
  avgProcessingTime: '0ms'
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Service Availability > should return 503 when embedding service fails to initialize
[cron] Found 1 assets needing embeddings

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Statistics > should return correct processing stats
[cron] Found 2 assets needing embeddings
[cron] Processing asset asset-1 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-1 (0ms)
[cron] Processing asset asset-2 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-2 (0ms)
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 2,
  successful: 2,
  failed: 0,
  successRate: '100%',
  avgProcessingTime: '0ms'
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should only audit non-deleted assets
[cron] Auditing 0 assets across all users...

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should use HEAD request for blob checks
[cron] Auditing 1 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 1,
  valid: 1,
  broken: 0,
  errors: 0,
  percentBroken: '0.00%',
  usersAffected: 0
}

stdout | __tests__/api/cron/audit-assets.test.ts > /api/cron/audit-assets > Asset Auditing > should include timeout in blob checks
[cron] Auditing 1 assets across all users...
[cron] Audit complete: {
  totalTime: '0ms',
  totalAssets: 1,
  valid: 1,
  broken: 0,
  errors: 0,
  percentBroken: '0.00%',
  usersAffected: 0
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Statistics > should calculate success rate correctly with failures
[cron] Found 10 assets needing embeddings
[cron] Processing asset asset-0 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-0 (0ms)
[cron] Processing asset asset-1 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-1 (0ms)
[cron] Processing asset asset-2 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Processing asset asset-3 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-3 (0ms)
[cron] Processing asset asset-4 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Processing asset asset-5 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-5 (0ms)
[cron] Processing asset asset-6 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-6 (0ms)
[cron] Processing asset asset-7 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-7 (0ms)
[cron] Processing asset asset-8 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Processing asset asset-9 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-9 (0ms)
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 10,
  successful: 7,
  failed: 3,
  successRate: '70%',
  avgProcessingTime: '0ms'
}

stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Statistics > should calculate average processing time correctly
[cron] Found 1 assets needing embeddings
[cron] Processing asset asset-1 (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Successfully generated embedding for asset asset-1 (0ms)
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 1,
  successful: 1,
  failed: 0,
  successRate: '100%',
  avgProcessingTime: '0ms'
}

 âœ“ __tests__/api/cron/audit-assets.test.ts (16 tests) 9ms
stdout | __tests__/api/cron/process-embeddings.test.ts > /api/cron/process-embeddings > Statistics > should handle zero success rate correctly
[cron] Found 1 assets needing embeddings
[cron] Processing asset asset-fail (created Thu Oct 02 2025 10:36:21 GMT-0500 (Central Daylight Time))
[cron] Processing complete: {
  totalTime: '0ms',
  processed: 1,
  successful: 0,
  failed: 1,
  successRate: '0%',
  avgProcessingTime: '0ms'
}

 âœ“ __tests__/api/cron/process-embeddings.test.ts (19 tests) 10ms
stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should return success when no assets need purging
[cron] Found 0 assets to purge (deleted >2025-09-02T17:36:21.108Z)

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should only delete assets where deletedAt > 30 days ago
[cron] Found 0 assets to purge (deleted >2025-09-02T17:36:21.109Z)

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should successfully purge assets older than 30 days
[cron] Found 2 assets to purge (deleted >2025-09-02T17:36:21.109Z)
[cron] Purging asset asset-old-1 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/old-1.jpg
[cron]   Deleted blob: https://blob.vercel-storage.com/old-1-thumb.jpg
[cron]   Successfully purged asset asset-old-1
[cron] Purging asset asset-old-2 (deleted Mon Sep 01 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/old-2.jpg
[cron]   Successfully purged asset asset-old-2
[cron] Purge complete: {
  totalTime: '1ms',
  found: 2,
  purged: 2,
  failed: 0,
  blobsDeleted: 3,
  successRate: '100%'
}

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should handle blob deletion failures gracefully
[cron] Found 1 assets to purge (deleted >2025-09-02T17:36:21.111Z)
[cron] Purging asset asset-1 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Successfully purged asset asset-1
[cron] Purge complete: {
  totalTime: '0ms',
  found: 1,
  purged: 1,
  failed: 0,
  blobsDeleted: 0,
  successRate: '100%'
}

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should continue processing after single asset failure
[cron] Found 2 assets to purge (deleted >2025-09-02T17:36:21.112Z)
[cron] Purging asset asset-fail (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/fail.jpg
[cron] Purging asset asset-success (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/success.jpg
[cron]   Successfully purged asset asset-success
[cron] Purge complete: {
  totalTime: '0ms',
  found: 2,
  purged: 1,
  failed: 1,
  blobsDeleted: 2,
  successRate: '50%'
}

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should return correct counts (purgedCount, failedCount, blobsDeleted)
[cron] Found 2 assets to purge (deleted >2025-09-02T17:36:21.113Z)
[cron] Purging asset asset-1 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/1.jpg
[cron]   Deleted blob: https://blob.vercel-storage.com/1-thumb.jpg
[cron]   Successfully purged asset asset-1
[cron] Purging asset asset-2 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/2.jpg
[cron]   Deleted blob: https://blob.vercel-storage.com/2-thumb.jpg
[cron]   Successfully purged asset asset-2
[cron] Purge complete: {
  totalTime: '0ms',
  found: 2,
  purged: 2,
  failed: 0,
  blobsDeleted: 4,
  successRate: '100%'
}

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should handle empty result set (no assets to purge)
[cron] Found 0 assets to purge (deleted >2025-09-02T17:36:21.113Z)

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should include cutoffDate in response when assets are purged
[cron] Found 1 assets to purge (deleted >2025-09-02T17:36:21.114Z)
[cron] Purging asset asset-1 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/test.jpg
[cron]   Successfully purged asset asset-1
[cron] Purge complete: {
  totalTime: '0ms',
  found: 1,
  purged: 1,
  failed: 0,
  blobsDeleted: 1,
  successRate: '100%'
}

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should calculate success rate correctly
[cron] Found 10 assets to purge (deleted >2025-09-02T17:36:21.114Z)
[cron] Purging asset asset-0 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/0.jpg
[cron]   Successfully purged asset asset-0
[cron] Purging asset asset-1 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/1.jpg
[cron]   Successfully purged asset asset-1
[cron] Purging asset asset-2 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/2.jpg
[cron] Purging asset asset-3 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/3.jpg
[cron]   Successfully purged asset asset-3
[cron] Purging asset asset-4 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/4.jpg
[cron] Purging asset asset-5 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/5.jpg
[cron]   Successfully purged asset asset-5
[cron] Purging asset asset-6 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/6.jpg
[cron]   Successfully purged asset asset-6
[cron] Purging asset asset-7 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/7.jpg
[cron]   Successfully purged asset asset-7
[cron] Purging asset asset-8 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/8.jpg
[cron] Purging asset asset-9 (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/9.jpg
[cron]   Successfully purged asset asset-9
[cron] Purge complete: {
  totalTime: '0ms',
  found: 10,
  purged: 7,
  failed: 3,
  blobsDeleted: 10,
  successRate: '70%'
}

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should delete both blobUrl and thumbnailUrl when present
[cron] Found 1 assets to purge (deleted >2025-09-02T17:36:21.117Z)
[cron] Purging asset asset-with-thumb (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/main.jpg
[cron]   Deleted blob: https://blob.vercel-storage.com/thumb.jpg
[cron]   Successfully purged asset asset-with-thumb
[cron] Purge complete: {
  totalTime: '0ms',
  found: 1,
  purged: 1,
  failed: 0,
  blobsDeleted: 2,
  successRate: '100%'
}

stdout | __tests__/api/cron/purge-deleted-assets.test.ts > /api/cron/purge-deleted-assets > Asset Purging > should only delete blobUrl when thumbnailUrl is null
[cron] Found 1 assets to purge (deleted >2025-09-02T17:36:21.118Z)
[cron] Purging asset asset-no-thumb (deleted Thu Aug 28 2025 12:36:21 GMT-0500 (Central Daylight Time))
[cron]   Deleted blob: https://blob.vercel-storage.com/main.jpg
[cron]   Successfully purged asset asset-no-thumb
[cron] Purge complete: {
  totalTime: '0ms',
  found: 1,
  purged: 1,
  failed: 0,
  blobsDeleted: 1,
  successRate: '100%'
}

 âœ“ __tests__/api/cron/purge-deleted-assets.test.ts (16 tests) 17ms
 â¯ __tests__/integration/upload-flow.test.ts (0 test)
stdout | __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Background Embedding Generation > should generate embeddings in background within 10 seconds
[EmbeddingQueue] Successfully generated embedding for asset-123

stdout | __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Background Embedding Generation > should process queue in FIFO order with priority support
[EmbeddingQueue] Successfully generated embedding for normal-1
[EmbeddingQueue] Successfully generated embedding for high-1
[EmbeddingQueue] Successfully generated embedding for normal-2

 âœ“ __tests__/contexts/filter-context.test.tsx (23 tests) 62ms
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should upload 5 images simultaneously
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

stdout | __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Retry Logic > should automatically retry failed embeddings with exponential backoff
[EmbeddingQueue] Successfully generated embedding for retry-test

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should upload 5 images simultaneously
[EmbeddingQueue] Successfully generated embedding for asset-upload-5

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should upload 5 images simultaneously
[EmbeddingQueue] Successfully generated embedding for asset-upload-2

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should upload 5 images simultaneously
[EmbeddingQueue] Successfully generated embedding for asset-upload-1
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should show "uploading" state immediately for all files
[EmbeddingQueue] Successfully generated embedding for asset-upload-2

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should show "uploading" state immediately for all files
[EmbeddingQueue] Successfully generated embedding for asset-upload-5

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should show "uploading" state immediately for all files
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should show "uploading" state immediately for all files
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should show "uploading" state immediately for all files
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should complete all uploads within 5 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should complete all uploads within 5 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-5

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should complete all uploads within 5 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

stdout | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Retry Logic > should retry failed items with exponential backoff
[DistributedQueue] Retrying item 1759426581864-rwi8wiwfc (attempt 1) after 2000ms
[DistributedQueue] Retrying item 1759426581864-rwi8wiwfc (attempt 2) after 4000ms

stdout | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Retry Logic > should move items to dead letter queue after max retries
[DistributedQueue] Retrying item 1759426581866-6r6dvyq5z (attempt 1) after 3000ms

stderr | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Retry Logic > should not retry invalid errors
[DistributedQueue] Item 1759426581866-m3hwi1sg4 moved to deadletter after 1 retries: Error: Invalid request
    at /Users/phaedrus/Development/sploot/__tests__/lib/distributed-queue.test.ts:137:28
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:146:14
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:533:11
    at runWithTimeout (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:39:7)
    at runTest (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1056:17)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runFiles (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1262:5)

stdout | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Dead Letter Queue > should allow retrying dead letter items
[DistributedQueue] Retrying item 1759426581867-5wmidzh9y (attempt 1) after 2000ms

stdout | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Error Classification > should classify errors correctly
[DistributedQueue] Retrying item 1759426581868-t7gzm2gfu (attempt 1) after 5000ms

stdout | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Error Classification > should classify errors correctly
[DistributedQueue] Retrying item 1759426581879-e20roxl4j (attempt 1) after 2000ms

stdout | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Error Classification > should classify errors correctly
[DistributedQueue] Retrying item 1759426581890-v5ydf6vqs (attempt 1) after 3000ms

stderr | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Error Classification > should classify errors correctly
[DistributedQueue] Item 1759426581900-ansn738vs moved to deadletter after 1 retries: Error: Invalid request format
    at /Users/phaedrus/Development/sploot/__tests__/lib/distributed-queue.test.ts:283:63
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:533:5
    at runTest (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1056:11)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runFiles (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1262:5)
    at startTests (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1271:3)
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/vitest@2.1.9_@types+node@20.19.14_@vitest+ui@2.1.9_jsdom@25.0.1_lightningcss@1.30.1_terser@5.44.0/node_modules/vitest/dist/chunks/runBaseTests.3qpJUEJM.js:126:11
    at withEnv (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/vitest@2.1.9_@types+node@20.19.14_@vitest+ui@2.1.9_jsdom@25.0.1_lightningcss@1.30.1_terser@5.44.0/node_modules/vitest/dist/chunks/runBaseTests.3qpJUEJM.js:90:5)

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should complete all uploads within 5 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

stdout | __tests__/lib/distributed-queue.test.ts > DistributedQueue > Error Classification > should classify errors correctly
[DistributedQueue] Retrying item 1759426581912-y2ym5uutd (attempt 1) after 2000ms

 â¯ __tests__/api/asset-crud.test.ts (0 test)
 â¯ __tests__/lib/distributed-queue.test.ts (13 tests | 5 failed) 71ms
   Ã— DistributedQueue > Priority Processing > should maintain FIFO order within same priority 6ms
     â†’ expected [ 'normal-1', 'normal-3', 'normal-2' ] to deeply equal [ 'normal-1', 'normal-2', 'normal-3' ]
   Ã— DistributedQueue > Retry Logic > should move items to dead letter queue after max retries 1ms
     â†’ expected +0 to be 1 // Object.is equality
   Ã— DistributedQueue > Dead Letter Queue > should allow retrying dead letter items 0ms
     â†’ expected +0 to be 1 // Object.is equality
   Ã— DistributedQueue > Metrics > should track success metrics 0ms
     â†’ expected 0 to be greater than 0
   Ã— DistributedQueue > Concurrent Processing > should process multiple items concurrently 0ms
     â†’ jest is not defined
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should complete all uploads within 5 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-2
Batch Upload Performance:
Total time for 5 uploads: 280ms
Average per upload: 56ms

 âœ“ __tests__/components/library/image-tile-error-boundary.test.tsx (19 tests) 129ms
 âœ“ __tests__/components/chrome/view-mode-toggle.test.tsx (36 tests) 188ms
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should make all images searchable within 15 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

 âœ“ __tests__/components/chrome/filter-chips.test.tsx (32 tests) 200ms
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should make all images searchable within 15 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should make all images searchable within 15 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-5

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should make all images searchable within 15 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should make all images searchable within 15 seconds
[EmbeddingQueue] Successfully generated embedding for asset-upload-2

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should make all images searchable within 15 seconds
Time to Searchable:
Total time: 381ms
upload-1: Upload 140ms, Embedding 241ms, Total 381ms
upload-2: Upload 281ms, Embedding 100ms, Total 381ms
upload-3: Upload 152ms, Embedding 229ms, Total 381ms
upload-4: Upload 257ms, Embedding 124ms, Total 381ms
upload-5: Upload 204ms, Embedding 177ms, Total 381ms

 âœ“ __tests__/components/chrome/command-palette.test.tsx (30 tests) 519ms
stderr | __tests__/components/chrome/search-bar-elastic.test.tsx > SearchBarElastic > Keyboard Navigation > should focus search input when / shortcut is triggered
An update to SearchBarElastic inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://react.dev/link/wrap-tests-with-act
An update to SearchBarElastic inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://react.dev/link/wrap-tests-with-act

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should find uploaded images through search
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should find uploaded images through search
[EmbeddingQueue] Successfully generated embedding for asset-upload-2

 âœ“ __tests__/components/chrome/search-bar-elastic.test.tsx (32 tests) 596ms
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should find uploaded images through search
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

 â¯ __tests__/api/assets.test.ts (0 test)
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should find uploaded images through search
[EmbeddingQueue] Successfully generated embedding for asset-upload-5

 â¯ __tests__/api/cache-stats.test.ts (0 test)
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should find uploaded images through search
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

 â¯ __tests__/lib/db-asset-exists.test.ts (9 tests | 9 failed) 12ms
   Ã— assetExists > when asset exists > should return typed asset metadata 8ms
     â†’ assetExists is not a function
   Ã— assetExists > when asset exists > should use transaction when provided 1ms
     â†’ assetExists is not a function
   Ã— assetExists > when asset exists > should include embedding flag when requested 0ms
     â†’ assetExists is not a function
   Ã— assetExists > when asset does not exist > should return null 0ms
     â†’ assetExists is not a function
   Ã— assetExists > error handling > should throw when database error occurs 0ms
     â†’ assetExists is not a function
   Ã— findOrCreateAsset > when asset does not exist > should create new asset 0ms
     â†’ findOrCreateAsset is not a function
   Ã— findOrCreateAsset > when asset already exists > should return existing asset 0ms
     â†’ findOrCreateAsset is not a function
   Ã— findOrCreateAsset > race condition handling > should handle unique constraint violation 0ms
     â†’ findOrCreateAsset is not a function
   Ã— findOrCreateAsset > race condition handling > should throw on other errors 0ms
     â†’ findOrCreateAsset is not a function
 â¯ __tests__/api/search-advanced.test.ts (0 test)
stderr | __tests__/api/upload-preflight.test.ts > /api/upload/check > POST > should handle authentication errors
Error in upload preflight check: Error: Authentication failed
    at /Users/phaedrus/Development/sploot/__tests__/api/upload-preflight.test.ts:120:51
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:146:14
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:533:11
    at runWithTimeout (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:39:7)
    at runTest (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1056:17)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runFiles (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1262:5)

 â¯ __tests__/api/upload-preflight.test.ts (8 tests | 3 failed) 32ms
   Ã— /api/upload/check > POST > should return exists=true with asset data when duplicate found 7ms
     â†’ expected { id: 'asset-123', â€¦(10) } to deeply equal { id: 'asset-123', â€¦(10) }
   Ã— /api/upload/check > POST > should handle database unavailable 0ms
     â†’ jest is not defined
   Ã— Client-side checksum utilities > should calculate SHA256 checksum 10ms
     â†’ file.arrayBuffer is not a function
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle concurrent uploads efficiently
[EmbeddingQueue] Successfully generated embedding for asset-upload-2

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle concurrent uploads efficiently
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

stdout | __tests__/lib/metrics-collector.test.ts > MetricsCollector > Upload Metrics > should track upload lifecycle
[Metrics] Upload test-upload-1 completed: {
  duration: '0.00s',
  size: '0.00MB',
  throughput: '8.92MB/s',
  chunks: 2,
  retries: 0
}

stdout | __tests__/lib/metrics-collector.test.ts > MetricsCollector > Comprehensive Report > should generate complete metrics report
[Metrics] Upload upload-1 completed: {
  duration: '0.00s',
  size: '1.00MB',
  throughput: '452898.55MB/s',
  chunks: 1,
  retries: 0
}

 âœ“ __tests__/lib/metrics-collector.test.ts (7 tests) 4ms
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle concurrent uploads efficiently
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle concurrent uploads efficiently
[EmbeddingQueue] Successfully generated embedding for asset-upload-5

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle concurrent uploads efficiently
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

 â¯ __tests__/api/upload-url.test.ts (8 tests | 7 failed) 4ms
   Ã— /api/upload-url > POST > should return 401 if user is not authenticated 2ms
     â†’ mockAuth.mockResolvedValue is not a function
   Ã— /api/upload-url > POST > should return 400 if filename is missing 0ms
     â†’ mockAuth.mockResolvedValue is not a function
   Ã— /api/upload-url > POST > should return 400 if mimeType is missing 0ms
     â†’ mockAuth.mockResolvedValue is not a function
   Ã— /api/upload-url > POST > should return 400 for invalid file type 0ms
     â†’ mockAuth.mockResolvedValue is not a function
   Ã— /api/upload-url > POST > should successfully generate upload URL for valid image 0ms
     â†’ mockAuth.mockResolvedValue is not a function
   Ã— /api/upload-url > POST > should handle different valid image types 0ms
     â†’ mockAuth.mockResolvedValue is not a function
   Ã— /api/upload-url > POST > should handle blob storage errors gracefully 0ms
     â†’ mockAuth.mockResolvedValue is not a function
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should track performance metrics accurately
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should track performance metrics accurately
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

 âœ“ __tests__/components/chrome/navbar.test.tsx (14 tests) 73ms
 âœ“ __tests__/api/health.test.ts (2 tests) 3ms
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should track performance metrics accurately
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should track performance metrics accurately
[EmbeddingQueue] Successfully generated embedding for asset-upload-2

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should track performance metrics accurately
[EmbeddingQueue] Successfully generated embedding for asset-upload-5
Performance Metrics:
Average upload time: 201.0ms
Max upload time: 260.0ms

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle upload errors gracefully
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle upload errors gracefully
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

stderr | __tests__/integration/user-journey.test.ts > E2E: user journey in mock mode > allows upload, favorite toggling, and semantic search
Vercel Blob error: BlobAccessError: Vercel Blob: Access denied, please provide a valid token for this resource.
    at getBlobError (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vercel+blob@1.1.1/node_modules/@vercel/blob/src/api.ts:209:15)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vercel+blob@1.1.1/node_modules/@vercel/blob/src/api.ts:360:31
    at requestApi (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vercel+blob@1.1.1/node_modules/@vercel/blob/src/api.ts:285:23)
    at Module.put (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vercel+blob@1.1.1/node_modules/@vercel/blob/src/put.ts:63:22)
    at generateUploadUrl (/Users/phaedrus/Development/sploot/app/api/upload-url/route.ts:95:18)
    at POST (/Users/phaedrus/Development/sploot/app/api/upload-url/route.ts:51:40)
    at /Users/phaedrus/Development/sploot/__tests__/integration/user-journey.test.ts:65:23
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:533:5
    at runTest (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1056:11)
Upload URL generation error: Error: Failed to generate upload URL. Please check your Vercel Blob configuration.
    at generateUploadUrl (/Users/phaedrus/Development/sploot/app/api/upload-url/route.ts:120:11)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at POST (/Users/phaedrus/Development/sploot/app/api/upload-url/route.ts:51:40)
    at /Users/phaedrus/Development/sploot/__tests__/integration/user-journey.test.ts:65:23
    at file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:533:5
    at runTest (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1056:11)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runSuite (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1205:15)
    at runFiles (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1262:5)
    at startTests (file:///Users/phaedrus/Development/sploot/node_modules/.pnpm/@vitest+runner@2.1.9/node_modules/@vitest/runner/dist/index.js:1271:3)

 â¯ __tests__/integration/user-journey.test.ts (1 test | 1 failed) 412ms
   Ã— E2E: user journey in mock mode > allows upload, favorite toggling, and semantic search 411ms
     â†’ expected 500 to be 200 // Object.is equality
stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should maintain upload order in results
[EmbeddingQueue] Successfully generated embedding for asset-upload-4

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should maintain upload order in results
[EmbeddingQueue] Successfully generated embedding for asset-upload-5

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should maintain upload order in results
[EmbeddingQueue] Successfully generated embedding for asset-upload-1

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should maintain upload order in results
[EmbeddingQueue] Successfully generated embedding for asset-upload-3

stdout | __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should maintain upload order in results
[EmbeddingQueue] Successfully generated embedding for asset-upload-2

 â¯ __tests__/e2e/batch-upload.spec.ts (10 tests | 1 failed) 2810ms
   âœ“ E2E: Batch Upload > should make all images searchable within 15 seconds 382ms
   âœ“ E2E: Batch Upload > should find uploaded images through search 547ms
   Ã— E2E: Batch Upload > should handle concurrent uploads efficiently 236ms
     â†’ expected 5 to be less than or equal to 3
stdout | __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Network Interruption Recovery > should recover from network interruption and resume processing
[EmbeddingQueue] Successfully generated embedding for network-recovery-test

stdout | __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Network Interruption Recovery > should persist queue to localStorage for recovery after page reload
[EmbeddingQueue] Successfully generated embedding for persist-test-1

stdout | __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Network Interruption Recovery > should handle offline mode gracefully
[EmbeddingQueue] Successfully generated embedding for offline-test

 â¯ __tests__/embeddings/embedding-generation.test.ts (15 tests | 6 failed) 10366ms
   Ã— Embedding Generation Test Suite > Background Embedding Generation > should process queue in FIFO order with priority support 147ms
     â†’ expected 'normal-1' to be 'high-1' // Object.is equality
   Ã— Embedding Generation Test Suite > Retry Logic > should automatically retry failed embeddings with exponential backoff 5003ms
     â†’ expected [ 'completed' ] to include 'retry'
   Ã— Embedding Generation Test Suite > Concurrent Uploads > should respect MAX_CONCURRENT_UPLOADS limit 202ms
     â†’ expected 9 to be less than or equal to 3
   Ã— Embedding Generation Test Suite > Network Interruption Recovery > should recover from network interruption and resume processing 5002ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Embedding Generation Test Suite > Network Interruption Recovery > should persist queue to localStorage for recovery after page reload 1ms
     â†’ expected 1 to be greater than or equal to 2
   Ã— Embedding Generation Test Suite > Network Interruption Recovery > should handle offline mode gracefully 0ms
     â†’ expected 0 to be greater than 0
stdout | __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Performance Metrics > should track comprehensive performance metrics
[perf] Performance Summary:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (index) â”‚ Operation                 â”‚ Samples â”‚ Avg (ms) â”‚ Median (ms) â”‚ Min (ms) â”‚ Max (ms) â”‚ P95 (ms) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0       â”‚ 'upload:blob_storage'     â”‚ 1       â”‚ '200.0'  â”‚ '200.0'     â”‚ '200.0'  â”‚ '200.0'  â”‚ '200.0'  â”‚
â”‚ 1       â”‚ 'upload:database_write'   â”‚ 1       â”‚ '50.0'   â”‚ '50.0'      â”‚ '50.0'   â”‚ '50.0'   â”‚ '50.0'   â”‚
â”‚ 2       â”‚ 'embedding:generate'      â”‚ 1       â”‚ '3000.0' â”‚ '3000.0'    â”‚ '3000.0' â”‚ '3000.0' â”‚ '3000.0' â”‚
â”‚ 3       â”‚ 'embedding:queue_wait'    â”‚ 1       â”‚ '100.0'  â”‚ '100.0'     â”‚ '100.0'  â”‚ '100.0'  â”‚ '100.0'  â”‚
â”‚ 4       â”‚ 'embedding:replicate_api' â”‚ 1       â”‚ '2500.0' â”‚ '2500.0'    â”‚ '2500.0' â”‚ '2500.0' â”‚ '2500.0' â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

stdout | __tests__/e2e/large-batch-upload.spec.ts > Large Batch Upload Performance Test > should handle mixed file sizes appropriately
=== Large Batch Upload Performance Results ===
Total Files: 100
Total Time: 2.71s
Average Upload Time: 0.93s
Success Rate: 72.1%
Failure Rate: 0.0%
Peak Memory: 185.0MB
Average Memory: 164.2MB
Throughput: 11.44 files/sec

 â¯ __tests__/e2e/large-batch-upload.spec.ts (6 tests | 4 failed) 24568ms
   Ã— Large Batch Upload Performance Test > should handle 100 simultaneous files within performance targets 5231ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Large Batch Upload Performance Test > should maintain responsive UI during large batch upload 5031ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Large Batch Upload Performance Test > should handle memory efficiently with cleanup 5050ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   Ã— Large Batch Upload Performance Test > should handle mixed file sizes appropriately 5035ms
     â†’ Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
   âœ“ Large Batch Upload Performance Test > should recover from failures gracefully 4218ms

â¯â¯â¯â¯â¯â¯ Failed Suites 7 â¯â¯â¯â¯â¯â¯â¯

 FAIL  __tests__/api/asset-crud.test.ts [ __tests__/api/asset-crud.test.ts ]
 FAIL  __tests__/api/assets.test.ts [ __tests__/api/assets.test.ts ]
 FAIL  __tests__/integration/upload-flow.test.ts [ __tests__/integration/upload-flow.test.ts ]
Error: [vitest] There was an error when mocking a module. If you are using "vi.mock" factory, make sure there are no top level variables inside, since this call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.html#vi-mock
 â¯ lib/auth/server.ts:2:31
      1| import { isMockMode } from '../env';
      2| import { getOrCreateUser } from '../db';
       |                               ^
      3| 
      4| interface AuthResult {

Caused by: Error: Cannot find module '../utils/test-helpers'
Require stack:
- /Users/phaedrus/Development/sploot/__tests__/api/asset-crud.test.ts
 â¯ __tests__/api/asset-crud.test.ts:7:19

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯
Serialized Error: { code: 'MODULE_NOT_FOUND', requireStack: [ '/Users/phaedrus/Development/sploot/__tests__/api/asset-crud.test.ts' ] }
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/43]â¯

 FAIL  __tests__/api/cache-stats.test.ts [ __tests__/api/cache-stats.test.ts ]
Error: Cannot find module '@/lib/multi-layer-cache'
Require stack:
- /Users/phaedrus/Development/sploot/__tests__/api/cache-stats.test.ts
 â¯ __tests__/api/cache-stats.test.ts:15:55
     13| 
     14| const mockAuth = require('@clerk/nextjs/server').auth;
     15| const { createMultiLayerCache, getMultiLayerCache } = require('@/lib/mâ€¦
       |                                                       ^
     16| 
     17| describe('/api/cache/stats', () => {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/43]â¯

 FAIL  __tests__/api/search-advanced.test.ts [ __tests__/api/search-advanced.test.ts ]
Error: [vitest] There was an error when mocking a module. If you are using "vi.mock" factory, make sure there are no top level variables inside, since this call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.html#vi-mock
 â¯ app/api/search/advanced/route.ts:2:31
      1| import { NextRequest, NextResponse } from 'next/server';
      2| import { prisma, databaseAvailable } from '@/lib/db';
       |                               ^
      3| import { createEmbeddingService, EmbeddingError } from '@/lib/embeddinâ€¦
      4| import { createMultiLayerCache, getMultiLayerCache } from '@/lib/multiâ€¦

Caused by: Error: Cannot find module '../utils/test-helpers'
Require stack:
- /Users/phaedrus/Development/sploot/__tests__/api/search-advanced.test.ts
 â¯ __tests__/api/search-advanced.test.ts:7:19

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯
Serialized Error: { code: 'MODULE_NOT_FOUND', requireStack: [ '/Users/phaedrus/Development/sploot/__tests__/api/search-advanced.test.ts' ] }
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/43]â¯

 FAIL  __tests__/api/search.test.ts [ __tests__/api/search.test.ts ]
 FAIL  __tests__/integration/search-flow.test.ts [ __tests__/integration/search-flow.test.ts ]
Error: [vitest] There was an error when mocking a module. If you are using "vi.mock" factory, make sure there are no top level variables inside, since this call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.html#vi-mock
 â¯ app/api/search/route.ts:2:31
      1| import { NextRequest, NextResponse } from 'next/server';
      2| import { prisma, databaseAvailable, vectorSearch, logSearch } from '@/â€¦
       |                               ^
      3| import { createEmbeddingService, EmbeddingError } from '@/lib/embeddinâ€¦
      4| import { createMultiLayerCache, getMultiLayerCache } from '@/lib/multiâ€¦

Caused by: Error: Cannot find module '../utils/test-helpers'
Require stack:
- /Users/phaedrus/Development/sploot/__tests__/api/search.test.ts
 â¯ __tests__/api/search.test.ts:7:19

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯
Serialized Error: { code: 'MODULE_NOT_FOUND', requireStack: [ '/Users/phaedrus/Development/sploot/__tests__/api/search.test.ts' ] }
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/43]â¯

â¯â¯â¯â¯â¯â¯ Failed Tests 36 â¯â¯â¯â¯â¯â¯â¯

 FAIL  __tests__/api/upload-preflight.test.ts > /api/upload/check > POST > should return exists=true with asset data when duplicate found
AssertionError: expected { id: 'asset-123', â€¦(10) } to deeply equal { id: 'asset-123', â€¦(10) }

- Expected
+ Received

  Object {
    "blobUrl": "https://blob.example.com/asset.jpg",
    "checksumSha256": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
-   "createdAt": "2024-01-01T00:00:00.000Z",
+   "createdAt": 2024-01-01T00:00:00.000Z,
    "hasEmbedding": true,
    "height": 600,
    "id": "asset-123",
    "mime": "image/jpeg",
    "pathname": "/uploads/asset.jpg",
    "size": 1024,
    "thumbnailUrl": "https://blob.example.com/asset-thumb.jpg",
    "width": 800,
  }

 â¯ __tests__/api/upload-preflight.test.ts:73:26
     71|       expect(response.status).toBe(200);
     72|       expect(data.exists).toBe(true);
     73|       expect(data.asset).toEqual({
       |                          ^
     74|         id: 'asset-123',
     75|         blobUrl: 'https://blob.example.com/asset.jpg',

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/43]â¯

 FAIL  __tests__/api/upload-preflight.test.ts > /api/upload/check > POST > should handle database unavailable
ReferenceError: jest is not defined
 â¯ __tests__/api/upload-preflight.test.ts:138:7
    136|     it('should handle database unavailable', async () => {
    137|       // Mock database unavailable by mocking the module
    138|       jest.doMock('@/lib/db', () => ({
       |       ^
    139|         databaseAvailable: false,
    140|         prisma: null,

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/43]â¯

 FAIL  __tests__/api/upload-preflight.test.ts > Client-side checksum utilities > should calculate SHA256 checksum
TypeError: file.arrayBuffer is not a function
 â¯ calculateSHA256 lib/checksum.ts:12:29
     10| export async function calculateSHA256(file: File | Blob): Promise<striâ€¦
     11|   // Read file as ArrayBuffer
     12|   const buffer = await file.arrayBuffer();
       |                             ^
     13| 
     14|   // Calculate SHA-256 hash using Web Crypto API
 â¯ __tests__/api/upload-preflight.test.ts:205:28

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/43]â¯

 FAIL  __tests__/api/upload-url.test.ts > /api/upload-url > POST > should return 401 if user is not authenticated
TypeError: mockAuth.mockResolvedValue is not a function
 â¯ __tests__/api/upload-url.test.ts:24:16
     22|   describe('POST', () => {
     23|     it('should return 401 if user is not authenticated', async () => {
     24|       mockAuth.mockResolvedValue({ userId: null });
       |                ^
     25| 
     26|       const request = createMockRequest('POST', {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/43]â¯

 FAIL  __tests__/api/upload-url.test.ts > /api/upload-url > POST > should return 400 if filename is missing
TypeError: mockAuth.mockResolvedValue is not a function
 â¯ __tests__/api/upload-url.test.ts:40:16
     38| 
     39|     it('should return 400 if filename is missing', async () => {
     40|       mockAuth.mockResolvedValue({ userId: 'test-user-id' });
       |                ^
     41| 
     42|       const request = createMockRequest('POST', {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/43]â¯

 FAIL  __tests__/api/upload-url.test.ts > /api/upload-url > POST > should return 400 if mimeType is missing
TypeError: mockAuth.mockResolvedValue is not a function
 â¯ __tests__/api/upload-url.test.ts:55:16
     53| 
     54|     it('should return 400 if mimeType is missing', async () => {
     55|       mockAuth.mockResolvedValue({ userId: 'test-user-id' });
       |                ^
     56| 
     57|       const request = createMockRequest('POST', {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/43]â¯

 FAIL  __tests__/api/upload-url.test.ts > /api/upload-url > POST > should return 400 for invalid file type
TypeError: mockAuth.mockResolvedValue is not a function
 â¯ __tests__/api/upload-url.test.ts:70:16
     68| 
     69|     it('should return 400 for invalid file type', async () => {
     70|       mockAuth.mockResolvedValue({ userId: 'test-user-id' });
       |                ^
     71| 
     72|       const request = createMockRequest('POST', {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[11/43]â¯

 FAIL  __tests__/api/upload-url.test.ts > /api/upload-url > POST > should successfully generate upload URL for valid image
TypeError: mockAuth.mockResolvedValue is not a function
 â¯ __tests__/api/upload-url.test.ts:86:16
     84| 
     85|     it('should successfully generate upload URL for valid image', asynâ€¦
     86|       mockAuth.mockResolvedValue({ userId: 'test-user-id' });
       |                ^
     87|       mockPut.mockResolvedValue({
     88|         url: 'https://example.blob.vercel-storage.com/test-123.jpg',

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[12/43]â¯

 FAIL  __tests__/api/upload-url.test.ts > /api/upload-url > POST > should handle different valid image types
TypeError: mockAuth.mockResolvedValue is not a function
 â¯ __tests__/api/upload-url.test.ts:118:16
    116| 
    117|     it('should handle different valid image types', async () => {
    118|       mockAuth.mockResolvedValue({ userId: 'test-user-id' });
       |                ^
    119|       mockPut.mockResolvedValue({
    120|         url: 'https://example.blob.vercel-storage.com/test-123.png',

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[13/43]â¯

 FAIL  __tests__/api/upload-url.test.ts > /api/upload-url > POST > should handle blob storage errors gracefully
TypeError: mockAuth.mockResolvedValue is not a function
 â¯ __tests__/api/upload-url.test.ts:149:16
    147| 
    148|     it('should handle blob storage errors gracefully', async () => {
    149|       mockAuth.mockResolvedValue({ userId: 'test-user-id' });
       |                ^
    150|       mockPut.mockRejectedValue(new Error('Storage error'));
    151| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[14/43]â¯

 FAIL  __tests__/e2e/batch-upload.spec.ts > E2E: Batch Upload > should handle concurrent uploads efficiently
AssertionError: expected 5 to be less than or equal to 3
 â¯ __tests__/e2e/batch-upload.spec.ts:445:27
    443|     // Should handle concurrent uploads (max 3 based on implementation)
    444|     expect(maxConcurrent).toBeGreaterThan(1); // Confirms parallelism
    445|     expect(maxConcurrent).toBeLessThanOrEqual(3); // Respects concurreâ€¦
       |                           ^
    446|   });
    447| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[15/43]â¯

 FAIL  __tests__/e2e/large-batch-upload.spec.ts > Large Batch Upload Performance Test > should handle 100 simultaneous files within performance targets
 FAIL  __tests__/e2e/large-batch-upload.spec.ts > Large Batch Upload Performance Test > should maintain responsive UI during large batch upload
 FAIL  __tests__/e2e/large-batch-upload.spec.ts > Large Batch Upload Performance Test > should handle memory efficiently with cleanup
 FAIL  __tests__/e2e/large-batch-upload.spec.ts > Large Batch Upload Performance Test > should handle mixed file sizes appropriately
 FAIL  __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Network Interruption Recovery > should recover from network interruption and resume processing
Error: Test timed out in 5000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[16/43]â¯

 FAIL  __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Background Embedding Generation > should process queue in FIFO order with priority support
AssertionError: expected 'normal-1' to be 'high-1' // Object.is equality

Expected: "high-1"
Received: "normal-1"

 â¯ __tests__/embeddings/embedding-generation.test.ts:220:33
    218|       await new Promise(resolve => setTimeout(resolve, 100));
    219| 
    220|       expect(processedOrder[0]).toBe('high-1');
       |                                 ^
    221|     });
    222|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[17/43]â¯

 FAIL  __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Retry Logic > should automatically retry failed embeddings with exponential backoff
AssertionError: expected [ 'completed' ] to include 'retry'
 â¯ __tests__/embeddings/embedding-generation.test.ts:264:31
    262|       // Should have retry events
    263|       const retryEventTypes = retryEvents.map(e => e.type);
    264|       expect(retryEventTypes).toContain('retry');
       |                               ^
    265| 
    266|       // Check exponential backoff timing

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[18/43]â¯

 FAIL  __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Concurrent Uploads > should respect MAX_CONCURRENT_UPLOADS limit
AssertionError: expected 9 to be less than or equal to 3
 â¯ __tests__/embeddings/embedding-generation.test.ts:419:29
    417| 
    418|       // Should never exceed max concurrent limit
    419|       expect(maxConcurrent).toBeLessThanOrEqual(MAX_CONCURRENT);
       |                             ^
    420|     });
    421|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[19/43]â¯

 FAIL  __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Network Interruption Recovery > should persist queue to localStorage for recovery after page reload
AssertionError: expected 1 to be greater than or equal to 2
 â¯ __tests__/embeddings/embedding-generation.test.ts:496:37
    494|         const parsed = JSON.parse(persistedData);
    495|         expect(parsed.queue).toBeDefined();
    496|         expect(parsed.queue.length).toBeGreaterThanOrEqual(2);
       |                                     ^
    497|         expect(parsed.timestamp).toBeDefined();
    498|       }

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[20/43]â¯

 FAIL  __tests__/embeddings/embedding-generation.test.ts > Embedding Generation Test Suite > Network Interruption Recovery > should handle offline mode gracefully
AssertionError: expected 0 to be greater than 0
 â¯ __tests__/embeddings/embedding-generation.test.ts:520:29
    518|       // Should be queued but not processing
    519|       const status = embeddingQueue.getStatus();
    520|       expect(status.queued).toBeGreaterThan(0);
       |                             ^
    521| 
    522|       // Simulate coming back online

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[21/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > assetExists > when asset exists > should return typed asset metadata
TypeError: assetExists is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:55:28
     53|       mockPrisma.asset.findFirst.mockResolvedValue(mockAsset);
     54| 
     55|       const result = await assetExists(mockUserId, mockChecksum);
       |                            ^
     56| 
     57|       expect(result).toEqual({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[22/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > assetExists > when asset exists > should use transaction when provided
TypeError: assetExists is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:81:13
     79|       mockTx.asset.findFirst.mockResolvedValue(mockAsset);
     80| 
     81|       await assetExists(mockUserId, mockChecksum, { tx: mockTx as any â€¦
       |             ^
     82| 
     83|       expect(mockTx.asset.findFirst).toHaveBeenCalledTimes(1);

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[23/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > assetExists > when asset exists > should include embedding flag when requested
TypeError: assetExists is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:95:28
     93|       });
     94| 
     95|       const result = await assetExists(mockUserId, mockChecksum, { incâ€¦
       |                            ^
     96| 
     97|       expect(result?.hasEmbedding).toBe(true);

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[24/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > assetExists > when asset does not exist > should return null
TypeError: assetExists is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:105:28
    103|       mockPrisma.asset.findFirst.mockResolvedValue(null);
    104| 
    105|       const result = await assetExists(mockUserId, mockChecksum);
       |                            ^
    106| 
    107|       expect(result).toBeNull();

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[25/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > assetExists > error handling > should throw when database error occurs
TypeError: assetExists is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:115:20
    113|       mockPrisma.asset.findFirst.mockRejectedValue(new Error('Databaseâ€¦
    114| 
    115|       await expect(assetExists(mockUserId, mockChecksum)).rejects.toThâ€¦
       |                    ^
    116|     });
    117|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[26/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > findOrCreateAsset > when asset does not exist > should create new asset
TypeError: findOrCreateAsset is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:160:28
    158|       });
    159| 
    160|       const result = await findOrCreateAsset(mockUserId, mockAssetDataâ€¦
       |                            ^
    161| 
    162|       expect(result).toEqual({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[27/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > findOrCreateAsset > when asset already exists > should return existing asset
TypeError: findOrCreateAsset is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:199:28
    197|       });
    198| 
    199|       const result = await findOrCreateAsset(mockUserId, mockAssetDataâ€¦
       |                            ^
    200| 
    201|       expect(mockTxAsset.create).not.toHaveBeenCalled();

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[28/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > findOrCreateAsset > race condition handling > should handle unique constraint violation
TypeError: findOrCreateAsset is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:238:28
    236|       });
    237| 
    238|       const result = await findOrCreateAsset(mockUserId, mockAssetDataâ€¦
       |                            ^
    239| 
    240|       expect(result.id).toBe('raceAsset123');

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[29/43]â¯

 FAIL  __tests__/lib/db-asset-exists.test.ts > findOrCreateAsset > race condition handling > should throw on other errors
TypeError: findOrCreateAsset is not a function
 â¯ __tests__/lib/db-asset-exists.test.ts:247:20
    245|       mockPrisma.$transaction.mockRejectedValue(new Error('Unexpected â€¦
    246| 
    247|       await expect(findOrCreateAsset(mockUserId, mockAssetData)).rejecâ€¦
       |                    ^
    248|     });
    249|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[30/43]â¯

 FAIL  __tests__/lib/distributed-queue.test.ts > DistributedQueue > Priority Processing > should maintain FIFO order within same priority
AssertionError: expected [ 'normal-1', 'normal-3', 'normal-2' ] to deeply equal [ 'normal-1', 'normal-2', 'normal-3' ]

- Expected
+ Received

  Array [
    "normal-1",
-   "normal-2",
    "normal-3",
+   "normal-2",
  ]

 â¯ __tests__/lib/distributed-queue.test.ts:74:25
     72|       await queue.processNext();
     73| 
     74|       expect(processed).toEqual(['normal-1', 'normal-2', 'normal-3']);
       |                         ^
     75|     });
     76|   });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[31/43]â¯

 FAIL  __tests__/lib/distributed-queue.test.ts > DistributedQueue > Retry Logic > should move items to dead letter queue after max retries
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 â¯ __tests__/lib/distributed-queue.test.ts:126:28
    124| 
    125|       const metrics = queue.getMetrics();
    126|       expect(metrics.dead).toBe(1);
       |                            ^
    127|       expect(metrics.failureCount).toBe(1);
    128| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[32/43]â¯

 FAIL  __tests__/lib/distributed-queue.test.ts > DistributedQueue > Dead Letter Queue > should allow retrying dead letter items
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 â¯ __tests__/lib/distributed-queue.test.ts:171:39
    169|       }
    170| 
    171|       expect(queue.getMetrics().dead).toBe(1);
       |                                       ^
    172| 
    173|       // Retry from dead letter

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[33/43]â¯

 FAIL  __tests__/lib/distributed-queue.test.ts > DistributedQueue > Metrics > should track success metrics
AssertionError: expected 0 to be greater than 0
 â¯ __tests__/lib/distributed-queue.test.ts:222:41
    220|       expect(metrics.successCount).toBe(2);
    221|       expect(metrics.failureCount).toBe(0);
    222|       expect(metrics.avgProcessingTime).toBeGreaterThan(0);
       |                                         ^
    223|     });
    224| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[34/43]â¯

 FAIL  __tests__/lib/distributed-queue.test.ts > DistributedQueue > Concurrent Processing > should process multiple items concurrently
ReferenceError: jest is not defined
 â¯ __tests__/lib/distributed-queue.test.ts:249:28
    247|   describe('Concurrent Processing', () => {
    248|     it('should process multiple items concurrently', async () => {
    249|       const slowExecutor = jest.fn(async () => {
       |                            ^
    250|         await new Promise(resolve => setTimeout(resolve, 100));
    251|       });

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[35/43]â¯

 FAIL  __tests__/integration/user-journey.test.ts > E2E: user journey in mock mode > allows upload, favorite toggling, and semantic search
AssertionError: expected 500 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 500

 â¯ __tests__/integration/user-journey.test.ts:66:30
     64| 
     65|     const uploadRes = await uploadUrlPOST(uploadReq);
     66|     expect(uploadRes.status).toBe(200);
       |                              ^
     67|     const uploadData = await uploadRes.json();
     68|     expect(uploadData.pathname).toBeDefined();

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[36/43]â¯

 Test Files  15 failed | 12 passed (27)
      Tests  36 failed | 280 passed (316)
   Start at  12:36:19
   Duration  25.78s (transform 971ms, setup 4.93s, collect 1.49s, tests 40.09s, environment 9.58s, prepare 2.38s)

â€‰ELIFECYCLEâ€‰ Test failed. See above for more details.
